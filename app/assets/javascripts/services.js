// Generated by CoffeeScript 2.6.1
(function() {
  window.ldc_services = (function() {
    var create_promises_url, delay, endpoint, newp, polltime, promises, services, servicesn;
    promises = null;
    services = {};
    servicesn = {};
    endpoint = 'https://hlt.ldcresearch.org';
    create_promises_url = null;
    polltime = 1000;
    newp = function(x, y) {
      return Promise.new(x, y);
    };
    delay = function(f) {
      var p;
      p = f();
      return setTimeout(newp, polltime, f);
    };
    return {
      init: function() {
        return ldc_nodes.getp_simple(endpoint).then(function(data) {
          console.log('SERVICES');
          console.log(data); //data.jsonapi.meta.types
          promises = data.promises;
          create_promises_url = `${endpoint}${promises.create_promise.uri}`;
          return $.each(data.promises.create_promise.schema, function(i, x) {
            return $.each(x, function(k, v) {
              return ldc_nodes.wait_for('.middle', function() {
                var ii;
                ii = `${i + 1}`;
                $('.middle').append(ldc_nodes.array2html(['div', `${ii} ${k}`]));
                services[k] = v;
                servicesn[ii] = k;
                if (k === 'sad') {
                  console.log(`${endpoint}${v}`);
                  return ldc_nodes.getp_simple(`${endpoint}${v}`).then(function(data) {
                    console.log('here');
                    console.log(data);
                    return $.each(data.required, function(i, x) {
                      return console.log(data.properties[x]);
                    });
                  });
                }
              });
            });
          });
        });
      },
      service_keys: function() {
        return servicesn;
      },
      sad: function(o, ff) {
        // url = 'https://nieuw-hlt.ldc.upenn.edu/promises'
        // url = url.replace ':4567', '' if external
        return ldc_nodes.post(create_promises_url, o, function(oo) {
          var f, url2;
          console.log('HERE');
          console.log(oo);
          url2 = oo.promiseStatusUrl;
          url2 = `${create_promises_url}/${oo.id}`;
          f = function() {
            return ldc_nodes.get(url2, function(data) {
              var url3;
              console.log("HERE");
              console.log(data);
              $('.waiting').append('*');
              if (data.status === 'resolved') {
                console.log('DONE');
                $('.waiting').remove();
                url3 = data.data[0].output;
                console.log(url3);
                return ldc_nodes.get(url3, function(data) {
                  return ff(data);
                });
              } else {
                return setTimeout(function() {
                  return f();
                }, 1000);
              }
            });
          };
          return f();
        });
      },
      align: function(data2, f22) {
        var f3, url;
        f3 = function(url3) {
          var o;
          console.log('BIGDaA');
          console.log(data2);
          o = {
            type: "alignment",
            data: {
              // wav: "/NIEUW02/promises/sad_in/#{w.wave_docid}.wav",
              audio: data2.audio,
              transcript: url3
            }
          };
          console.log('thisurl');
          console.log(url3);
          return ldc_nodes.post(create_promises_url, o, function(oo) {
            var f, url2;
            url2 = oo.promiseStatusUrl;
            url2 = `${create_promises_url}/${oo.id}`;
            f = function() {
              console.log(url2);
              return ldc_nodes.get(url2, function(data) {
                console.log("ALIGN");
                console.log(data);
                $('.waiting').append('*');
                if (data.status === 'resolved') {
                  console.log('ALIGNDONE');
                  $('.waiting').remove();
                  // $.get data.result, (data) ->
                  //     f2 data
                  // , 'text'
                  return data2.f22(data.result);
                } else {
                  return setTimeout(function() {
                    return f();
                  }, 1000);
                }
              });
            };
            return f();
          });
        };
        url = 'https://hlt.ldcresearch.org/uploads';
        return $.ajax({
          type: 'POST',
          url: url,
          data: data2.text,
          contentType: 'text/plain',
          success: f3
        });
      }
    };
  })();

}).call(this);
